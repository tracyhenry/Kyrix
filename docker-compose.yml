#
# to start up, simply run "./run-kyrix.sh" or "docker-compose up"
#  - kyrix frontend will be available on port 8000 by default
#  - postgres backend will be available on port 5432 by default (for debugging)
#

version: '3.4'

services:

  db:
    build:
      context: .
      dockerfile: docker-scripts/Dockerfile-db
      target: "${BUILD_STAGE:-pg-plv8}"
    restart: always
    ports: # comment-out for extra security or to avoid conflicts with host OS
     - "${DB_PORT:-5432}:5432"
    environment:
      POSTGRES_PASS: ${POSTGRES_PASSWORD:-kyrixftw}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
# for backup - requires special config on MacOS host OSs
#    volumes:
#     - /etc/postgresql:/etc/postgresql
#     - /var/log/postgresql:/var/log/postgresql
#     - /var/lib/postgresql:/var/lib/postgresql

  kyrix:
    build:
      context: .
      dockerfile: docker-scripts/Dockerfile-kyrix-alpine
    ports:
     - "${KYRIX_PORT:-8000}:8000"
    depends_on:
     - db
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-kyrixftw}
      KYRIX_PORT: ${KYRIX_PORT:-8000}
      START_APP: ${START_APP:-0}
    entrypoint: sh -c 'sleep 5; /wait-for-postgres db:5432 -t 60 -- /start-kyrix.sh; tail -f /dev/null'
