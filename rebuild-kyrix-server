#!/usr/bin/env bash

KV=${1:-adsah/kyrix:latest}

sudo docker build . -f Dockerfile-kyrix-alpine -t $KV
sudo docker push $KV

echo "updating kyrix-deployment.yaml"

# https://stackoverflow.com/questions/3466166/how-to-check-if-running-in-cygwin-mac-or-linux
# https://ed.gs/2016/01/26/os-x-sed-invalid-command-code/
if [ "$(uname)" == "Darwin" ]; then
    sed -i "" "s@image:.*@image: $KV@" kyrix-deployment.yaml
else
    sed -i "s@image:.*@image: $KV@" kyrix-deployment.yaml
fi

echo "build done: to redeploy, run './redeploy-kyrix-server'"
